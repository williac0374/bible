<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KJV Bible Navigator (Contextual)</title>
    <style>
        /* BASE STYLES */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f4f4f9;
            padding-bottom: 70px; 
        }
        #container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .section-title {
            margin-top: 10px;
            color: #333;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
        }
        .button-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        /* NAVIGATION BUTTON STYLES (Primary Selection) */
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            flex-grow: 1;
            min-width: 45px;
            text-align: center;
        }
        #booksList button { background-color: #28a745; }
        #chaptersList button { background-color: #007bff; }
        #versesList button { background-color: #ffc107; color: #333; min-width: 30px; padding: 6px 10px; }

        /* CONTEXTUAL NAVIGATION STYLES (Top of Screen) */
        .context-nav-btn {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 1.1em;
            display: inline-block;
            transition: background-color 0.1s;
        }
        #navBookTop { background-color: #d4edda; color: #1e7e34; } /* Book color */
        #navChapterTop { background-color: #cce5ff; color: #0056b3; } /* Chapter color */
        .context-nav-btn:hover {
            opacity: 0.8;
        }
        
        /* CONTENT DISPLAY AREA */
        #contentDisplay {
            padding: 15px;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 5px;
            line-height: 1.6;
            text-align: justify;
        }
        .chapter-heading {
            font-size: 1.5em;
            color: #007bff;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 5px;
            margin-top: 20px;
        }
        .highlighted-verse {
            background-color: #fffacd;
            border: 2px solid #ffcc00;
            padding: 5px;
            margin: 5px 0;
            border-radius: 3px;
        }
        
        /* FIXED BOTTOM NAVIGATION BAR */
        #bottomNav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background-color: #333;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        #bottomNav button {
            flex-basis: 30%;
            margin: 0 5px;
            font-size: 0.9em;
        }
        #navBookBtn { background-color: #28a745; }
        #navChapterBtn { background-color: #007bff; }
        #navVerseBtn { background-color: #ffc107; color: #333; }
    </style>
</head>
<body>

    <div id="container">
        
        <div id="mainView">
            <div id="booksSection">
                <h2 class="section-title">Select a Book</h2>
                <div id="booksList" class="button-list">
                    </div>
            </div>

            <div id="chaptersSection" style="display:none;">
                <h2 class="section-title">
                    <span id="bookContext"></span>
                    <span>Select Chapter:</span>
                </h2>
                <div id="chaptersList" class="button-list">
                    </div>
            </div>

            <div id="versesSection" style="display:none;">
                <h2 class="section-title">
                    <span id="bookContextVerse"></span>
                    <span id="chapterContextVerse"></span>
                    <span>Select Verse:</span>
                </h2>
                <div id="versesList" class="button-list">
                    </div>
            </div>
        </div>

        <div id="contentSection" style="display:none;">
            <h2 class="section-title">Reading: <span id="currentReference"></span></h2>
            <div id="contentDisplay">
                </div>
        </div>
    </div>

    <div id="bottomNav" style="display:none;">
        <button id="navBookBtn">Book</button>
        <button id="navChapterBtn">Chapter</button>
        <button id="navVerseBtn">Verse</button>
    </div>

    <script>
        // ASSUMPTION: The JSON files are in a directory named 'kjv'
        const KJV_DIR = './kjv/';
        
        // Element references
        const booksSection = document.getElementById('booksSection');
        const chaptersSection = document.getElementById('chaptersSection');
        const versesSection = document.getElementById('versesSection');
        const contentSection = document.getElementById('contentSection');
        const bottomNav = document.getElementById('bottomNav');
        const contentDisplay = document.getElementById('contentDisplay');

        // Contextual Navigation references
        const bookContext = document.getElementById('bookContext');
        const bookContextVerse = document.getElementById('bookContextVerse');
        const chapterContextVerse = document.getElementById('chapterContextVerse');

        // Nav button references (bottom fixed bar)
        const navBookBtn = document.getElementById('navBookBtn');
        const navChapterBtn = document.getElementById('navChapterBtn');
        const navVerseBtn = document.getElementById('navVerseBtn');

        // State management
        const bookDataCache = {};
        let currentBookData = null;
        let currentBookName = null;
        let currentChapterNumber = null;
        
        // --- View Visibility Functions (Unchanged) ---
        function showBooks() {
            bottomNav.style.display = 'none';
            booksSection.style.display = 'block';
            chaptersSection.style.display = 'none';
            versesSection.style.display = 'none';
            contentSection.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showChapters() {
            bottomNav.style.display = 'none';
            booksSection.style.display = 'none';
            chaptersSection.style.display = 'block';
            versesSection.style.display = 'none';
            contentSection.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function showVerses() {
            bottomNav.style.display = 'none';
            booksSection.style.display = 'none';
            chaptersSection.style.display = 'none';
            versesSection.style.display = 'block';
            contentSection.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showContent() {
            bottomNav.style.display = 'flex';
            booksSection.style.display = 'none';
            chaptersSection.style.display = 'none';
            versesSection.style.display = 'none';
            contentSection.style.display = 'block';
        }

        // --- 1. Load Initial Book List (Unchanged) ---
        async function loadBookList() {
             try {
                const response = await fetch(`${KJV_DIR}Books.json`);
                if (!response.ok) {
                    throw new Error("Could not find Books.json in the 'kjv' folder.");
                }
                const bookNames = await response.json();
                
                bookNames.forEach(bookName => {
                    const button = document.createElement('button');
                    button.textContent = bookName;
                    button.onclick = () => displayChapters(bookName);
                    document.getElementById('booksList').appendChild(button);
                });
                
            } catch (error) {
                console.error("Error loading book list:", error);
                document.getElementById('booksList').innerHTML = `<p style="color:red;">Error loading KJV Bible data. Check the console for details and ensure all 66 book JSON files (plus Books.json) are in a folder named 'kjv'.</p>`;
            }
        }
        
        // --- 2. Display Chapters (UPDATED for Contextual Nav) ---
        async function displayChapters(bookName) {
            document.getElementById('chaptersList').innerHTML = '';
            document.getElementById('versesList').innerHTML = '';
            currentBookName = bookName;
            
            // 1. UPDATE CONTEXTUAL NAVIGATION
            // In the Chapters view, only the Book link is shown
            bookContext.innerHTML = `<button id="navBookTop" class="context-nav-btn" onclick="showBooks()">${bookName}</button>`;
            
            showChapters(); // Show the chapters view
            
            // Load book data (from cache or fetch)
            if (!bookDataCache[bookName]) {
                try {
                    const fileName = `${bookName}.json`;
                    const response = await fetch(`${KJV_DIR}${fileName}`);
                    if (!response.ok) {
                        document.getElementById('chaptersList').innerHTML = `<p style="color:red;">Error: Could not find **${fileName}** in the 'kjv' folder.</p>`;
                        return;
                    }
                    bookDataCache[bookName] = await response.json();
                } catch (error) {
                    console.error(`Error fetching ${bookName} data:`, error);
                    document.getElementById('chaptersList').innerHTML = `<p style="color:red;">A network error occurred while fetching ${bookName}.json.</p>`;
                    return;
                }
            }
            
            currentBookData = bookDataCache[bookName];

            // Create chapter buttons
            currentBookData.chapters.forEach(chapter => {
                const chapterNumber = chapter.chapter;
                const button = document.createElement('button');
                button.textContent = chapterNumber;
                button.onclick = () => displayVerses(chapterNumber, chapter.verses);
                document.getElementById('chaptersList').appendChild(button);
            });
        }

        // --- 3. Display Verses (UPDATED for Contextual Nav) ---
        function displayVerses(chapterNumber, verses) {
            document.getElementById('versesList').innerHTML = '';
            currentChapterNumber = chapterNumber;

            // 1. UPDATE CONTEXTUAL NAVIGATION
            // In the Verses view, both Book and Chapter links are shown
            bookContextVerse.innerHTML = `<button id="navBookTop" class="context-nav-btn" onclick="showBooks()">${currentBookName}</button>`;
            chapterContextVerse.innerHTML = `<button id="navChapterTop" class="context-nav-btn" onclick="displayChapters('${currentBookName}')">Chapter ${chapterNumber}</button>`;
            
            showVerses(); // Show the verses view
            
            // Create verse buttons
            verses.forEach(verse => {
                const verseNumber = verse.verse;
                
                const button = document.createElement('button');
                button.textContent = verseNumber;
                
                // When clicked, display the final content
                button.onclick = () => displayFullBook(currentBookName, chapterNumber, verseNumber);
                document.getElementById('versesList').appendChild(button);
            });
        }

        // --- 4. Display FULL Book Content and Scroll to Verse (Unchanged logic) ---
        function displayFullBook(bookName, chapterNumber, verseNumber) {
            
            // Show the content view and fixed nav
            showContent();
            
            // Set reference header
            const reference = `${bookName} ${chapterNumber}:${verseNumber}`;
            document.getElementById('currentReference').textContent = reference;
            contentDisplay.innerHTML = ''; 
            
            // Set up Fixed Nav button handlers for easy jump
            navBookBtn.textContent = `Book: ${bookName}`;
            navChapterBtn.textContent = `Chapter: ${chapterNumber}`;
            navVerseBtn.textContent = `Verse: ${verseNumber}`;

            navBookBtn.onclick = showBooks;
            navChapterBtn.onclick = () => displayChapters(currentBookName); 
            const currentChapter = currentBookData.chapters.find(c => c.chapter === chapterNumber);
            navVerseBtn.onclick = () => displayVerses(currentChapter.chapter, currentChapter.verses);


            // Render all chapters and verses of the book
            const bookHTML = currentBookData.chapters.map(chapter => {
                let chapterHtml = `<h3 id="Ch${bookName}${chapter.chapter}" class="chapter-heading">Chapter ${chapter.chapter}</h3>`;
                
                chapter.verses.forEach(verse => {
                    const verseId = `V${bookName}${chapter.chapter}:${verse.verse}`;
                    let verseClass = 'verse-text';

                    // Check if this is the selected verse to highlight
                    if (chapter.chapter === chapterNumber && verse.verse === verseNumber) {
                        verseClass += ' highlighted-verse';
                    }
                    
                    chapterHtml += `<p id="${verseId}" class="${verseClass}"><strong>${verse.verse}.</strong> ${verse.text}</p>`;
                });
                return chapterHtml;
            }).join('');
            
            contentDisplay.innerHTML = bookHTML;

            // SCROLL to the selected verse
            const targetElementId = `V${bookName}${chapterNumber}:${verseNumber}`;
            const targetElement = document.getElementById(targetElementId);
            
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Initialize the app by loading the book buttons
        loadBookList();
    </script>

</body>
</html>
