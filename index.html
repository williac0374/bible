<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KJV Bible Navigator (Nature Theme)</title>
    <style>
        /* --- NATURE MEETS RELIGION THEME PALETTE --- */
        /* Primary: #4CAF50 (Forest Green - Life/Growth) */
        /* Secondary: #007bff (Deep Sky Blue - Divinity/Water) */
        /* Accent: #FFC107 (Goldenrod - Light/Glory) */
        /* Background: #f7f3e8 (Light Cream/Earth) */
        /* Neutral: #ffffff (White/Purity) */
        
        /* BASE STYLES */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f7f3e8; /* Light Cream/Earth Background */
            padding-top: 100px; 
        }
        #container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* FIXED HEADER WRAPPER */
        #fixedHeader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff; /* Clean White */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 10px;
            box-sizing: border-box;
        }
        
        /* CONTEXTUAL NAVIGATION & SECTION HEADINGS */
        .section-title {
            margin: 0; 
            color: #333;
            border-bottom: 2px solid #4CAF50; /* Green Separator */
            padding-bottom: 5px;
            display: flex; 
            flex-wrap: wrap; 
            align-items: center;
        }
        .context-nav-btn {
            padding: 5px 10px;
            border: 1px solid #c8e6c9; /* Lighter Green Border */
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px; 
            font-size: 1em;
            display: inline-block;
            transition: background-color 0.1s;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* Specific button colors for differentiation (Nature Tones) */
        #navBookTop { background-color: #e8f5e9; color: #1e7e34; } /* Pale Green */
        #navChapterTop { background-color: #e3f2fd; color: #007bff; } /* Pale Blue */
        #navVerseTop { background-color: #fffde7; color: #e0a800; } /* Pale Gold */
        .context-nav-btn:hover {
            opacity: 0.8;
        }
        
        /* SELECTION BUTTON LISTS (Remain below the fixed header) */
        .button-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        /* Style for primary selection buttons */
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            flex-grow: 1;
            min-width: 45px;
            text-align: center;
            transition: background-color 0.2s;
        }
        /* Color Mapping: Book=Green (Root), Chapter=Blue (Path), Verse=Gold (Light) */
        #booksList button { background-color: #4CAF50; }     /* Forest Green */
        #chaptersList button { background-color: #2196F3; }   /* Lighter Blue */
        #versesList button { background-color: #FFC107; color: #333; min-width: 30px; padding: 6px 10px; } /* Goldenrod */

        /* BIBLE CONTENT STYLES */
        #contentDisplay {
            padding: 15px;
            border: 1px solid #e0e0e0;
            background-color: #ffffff; /* White reading area */
            border-radius: 5px;
            line-height: 1.6;
            text-align: justify;
        }
        #contentDisplay p {
            font-size: 16px; /* Default font size (in pixels) */
        }
        .chapter-heading {
            font-size: 1.5em;
            color: #4CAF50; /* Green Chapter Headings */
            border-bottom: 1px dashed #c8e6c9;
            padding-bottom: 5px;
            margin-top: 20px;
        }
        .highlighted-verse {
            background-color: #fff8e1; /* Very pale gold highlight */
            border: 2px solid #ffeb3b; /* Brighter gold border */
            padding: 5px;
            margin: 5px 0;
            border-radius: 3px;
        }
    </style>
</head>
<body>

    <div id="fixedHeader">
        <div id="booksHeader">
            <h2 class="section-title">Select a Book</h2>
        </div>

        <div id="chaptersHeader" style="display:none;">
            <h2 class="section-title">
                <span id="bookContext"></span>
                <span>Select Chapter:</span>
            </h2>
        </div>

        <div id="versesHeader" style="display:none;">
            <h2 class="section-title">
                <span id="bookContextVerse"></span>
                <span id="chapterContextVerse"></span>
                <span>Select Verse:</span>
            </h2>
        </div>

        <div id="contentNavHeader" style="display:none;">
            <h2 class="section-title" id="contentHeader">
                </h2>
        </div>
    </div>
    <div id="container">
        <div id="booksSection">
            <div id="booksList" class="button-list">
                </div>
        </div>

        <div id="chaptersSection" style="display:none;">
            <div id="chaptersList" class="button-list">
                </div>
        </div>

        <div id="versesSection" style="display:none;">
            <div id="versesList" class="button-list">
                </div>
        </div>

        <div id="contentSection" style="display:none;">
            <div id="contentDisplay">
                </div>
        </div>
    </div>

    <script>
        // ASSUMPTION: The JSON files are in a directory named 'kjv'
        const KJV_DIR = './kjv/';
        
        // --- GLOBAL STATE ---
        const bookDataCache = {};
        let currentBookData = null;
        let currentBookName = null;
        let currentChapterNumber = null;
        let currentVerseNumber = null;
        let currentFontSize = 16; 
        
        // --- Element References ---
        const booksHeader = document.getElementById('booksHeader');
        const chaptersHeader = document.getElementById('chaptersHeader');
        const versesHeader = document.getElementById('versesHeader');
        const contentNavHeader = document.getElementById('contentNavHeader');
        const contentHeader = document.getElementById('contentHeader'); 
        const contentDisplay = document.getElementById('contentDisplay');

        // Content Area references
        const booksSection = document.getElementById('booksSection');
        const chaptersSection = document.getElementById('chaptersSection');
        const versesSection = document.getElementById('versesSection');
        const contentSection = document.getElementById('contentSection');

        // Contextual Navigation references
        const bookContext = document.getElementById('bookContext');
        const bookContextVerse = document.getElementById('bookContextVerse');
        const chapterContextVerse = document.getElementById('chapterContextVerse');

        // --- Helper function to display only one header group ---
        function showHeader(activeHeaderId) {
            booksHeader.style.display = 'none';
            chaptersHeader.style.display = 'none';
            versesHeader.style.display = 'none';
            contentNavHeader.style.display = 'none';
            
            if (activeHeaderId === 'books') {
                booksHeader.style.display = 'block';
            } else if (activeHeaderId === 'chapters') {
                chaptersHeader.style.display = 'block';
            } else if (activeHeaderId === 'verses') {
                versesHeader.style.display = 'block';
            } else if (activeHeaderId === 'content') {
                contentNavHeader.style.display = 'block';
                // Attach the long press listener whenever content header is shown
                setTimeout(attachLongPressListener, 0); 
            }
        }

        // --- Long Press Functionality ---
        let pressTimer;
        const LONG_PRESS_DURATION = 750; // milliseconds

        function startPress(event) {
            // Only attach to the Verse button in the content header
            if (event.target.id !== 'navVerseTop') return;

            // Prevent default short-click action for a moment
            event.preventDefault(); 
            
            pressTimer = setTimeout(() => {
                // SUCCESS: Long press detected
                showFontSizePrompt();
                
                // Clear the timer so the short-click handler is not accidentally called
                clearTimeout(pressTimer); 
                pressTimer = null;
                
            }, LONG_PRESS_DURATION);
        }

        function endPress(event) {
            if (pressTimer) {
                // Short click detected: clear the timer and proceed with the default action
                clearTimeout(pressTimer);
                pressTimer = null;
                
                // Since we used preventDefault in startPress, we must manually trigger the 
                // short-click behavior (displaying verses) if the press was short.
                if (event.target.id === 'navVerseTop') {
                    // Check if the current view is 'content' to avoid recursion/errors
                    if (contentNavHeader.style.display === 'block') {
                         // Find the correct onclick logic from the element itself
                        const onclickAttr = event.target.getAttribute('onclick');
                        if(onclickAttr) {
                            // Use setTimeout to ensure this runs after the main call stack clears
                            setTimeout(() => eval(onclickAttr), 0);
                        }
                    }
                }
            }
        }
        
        function showFontSizePrompt() {
            const newSize = prompt(`Enter new text size in pixels (current size: ${currentFontSize}px):`, currentFontSize);

            if (newSize !== null) {
                const parsedSize = parseInt(newSize, 10);
                
                if (parsedSize > 10 && !isNaN(parsedSize)) {
                    // 1. Update global state
                    currentFontSize = parsedSize;
                    
                    // 2. Apply new font size to the displayed content
                    document.styleSheets[0].insertRule(`#contentDisplay p { font-size: ${currentFontSize}px !important; }`, 0);
                    
                    // 3. Re-scroll to the current verse using global state (currentVerseNumber)
                    if (currentBookName && currentChapterNumber && currentVerseNumber) {
                         const targetElementId = `V${currentBookName}${currentChapterNumber}:${currentVerseNumber}`;
                         const targetElement = document.getElementById(targetElementId);
                         
                         if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                         }
                    }
                } else if (!isNaN(parsedSize)) {
                    alert("Font size must be a number greater than 10.");
                }
            }
        }
        
        function attachLongPressListener() {
            const verseBtn = document.getElementById('navVerseTop');
            
            if (verseBtn) {
                // Remove existing listeners to prevent duplicates
                verseBtn.removeEventListener('mousedown', startPress);
                verseBtn.removeEventListener('mouseup', endPress);
                verseBtn.removeEventListener('mouseleave', endPress);
                verseBtn.removeEventListener('touchstart', startPress);
                verseBtn.removeEventListener('touchend', endPress);
                
                // Attach new listeners for both mouse and touch
                verseBtn.addEventListener('mousedown', startPress);
                verseBtn.addEventListener('mouseup', endPress);
                verseBtn.addEventListener('mouseleave', endPress);
                verseBtn.addEventListener('touchstart', startPress);
                verseBtn.addEventListener('touchend', endPress);
            }
        }
        // --- End Long Press Functionality ---


        // --- View Visibility Functions ---
        function showBooks() {
            showHeader('books');
            booksSection.style.display = 'block';
            chaptersSection.style.display = 'none';
            versesSection.style.display = 'none';
            contentSection.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showChapters() {
            showHeader('chapters');
            booksSection.style.display = 'none';
            chaptersSection.style.display = 'block';
            versesSection.style.display = 'none';
            contentSection.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function showVerses() {
            showHeader('verses');
            booksSection.style.display = 'none';
            chaptersSection.style.display = 'none';
            versesSection.style.display = 'block';
            contentSection.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showContent() {
            showHeader('content');
            booksSection.style.display = 'none';
            chaptersSection.style.display = 'none';
            versesSection.style.display = 'none';
            contentSection.style.display = 'block';
        }

        // --- 1. Load Initial Book List ---
        async function loadBookList() {
             try {
                const response = await fetch(`${KJV_DIR}Books.json`);
                if (!response.ok) {
                    throw new Error("Could not find Books.json in the 'kjv' folder.");
                }
                const bookNames = await response.json();
                
                bookNames.forEach(bookName => {
                    const button = document.createElement('button');
                    button.textContent = bookName;
                    button.onclick = () => displayChapters(bookName);
                    document.getElementById('booksList').appendChild(button);
                });
                
            } catch (error) {
                console.error("Error loading book list:", error);
                document.getElementById('booksList').innerHTML = `<p style="color:red;">Error loading KJV Bible data. Check the console for details and ensure all 66 book JSON files (plus Books.json) are in a folder named 'kjv'.</p>`;
            }
        }
        
        // --- 2. Display Chapters (FIXED FOR SPACES IN FILENAME) ---
        async function displayChapters(bookName) {
            document.getElementById('chaptersList').innerHTML = '';
            document.getElementById('versesList').innerHTML = '';
            currentBookName = bookName;
            currentChapterNumber = null;
            currentVerseNumber = null;
            
            bookContext.innerHTML = `<button id="navBookTop" class="context-nav-btn" onclick="showBooks()">${bookName}</button>`;
            
            showChapters(); 
            
            if (!bookDataCache[bookName]) {
                try {
                    // FIX: Remove all spaces from the bookName to generate the correct file name 
                    // (e.g., "1 Samuel" becomes "1Samuel").
                    const cleanBookName = bookName.replace(/\s/g, ''); 
                    const fileName = `${cleanBookName}.json`; 
                    
                    const response = await fetch(`${KJV_DIR}${fileName}`);
                    if (!response.ok) {
                        document.getElementById('chaptersList').innerHTML = `<p style="color:red;">Error: Could not find **${fileName}** in the 'kjv' folder. (Checked: ${bookName})</p>`;
                        return;
                    }
                    bookDataCache[bookName] = await response.json();
                } catch (error) {
                    console.error(`Error fetching ${bookName} data:`, error);
                    document.getElementById('chaptersList').innerHTML = `<p style="color:red;">A network error occurred while fetching ${bookName}.json.</p>`;
                    return;
                }
            }
            
            currentBookData = bookDataCache[bookName];

            currentBookData.chapters.forEach(chapter => {
                const chapterNumber = chapter.chapter;
                const button = document.createElement('button');
                button.textContent = chapterNumber;
                button.onclick = () => displayVerses(chapterNumber, chapter.verses);
                document.getElementById('chaptersList').appendChild(button);
            });
        }

        // --- 3. Display Verses ---
        function displayVerses(chapterNumber, verses) {
            document.getElementById('versesList').innerHTML = '';
            currentChapterNumber = chapterNumber;
            currentVerseNumber = null; 

            bookContextVerse.innerHTML = `<button id="navBookTop" class="context-nav-btn" onclick="showBooks()">${currentBookName}</button>`;
            chapterContextVerse.innerHTML = `<button id="navChapterTop" class="context-nav-btn" onclick="displayChapters('${currentBookName}')">Chapter ${chapterNumber}</button>`;
            
            showVerses(); 
            
            verses.forEach(verse => {
                const verseNumber = verse.verse;
                const button = document.createElement('button');
                button.textContent = verseNumber;
                button.onclick = () => displayFullBook(currentBookName, chapterNumber, verseNumber);
                document.getElementById('versesList').appendChild(button);
            });
        }

     // --- 4. Display FULL Book Content and Scroll to Verse (FIXED Chapter Search) ---
function displayFullBook(bookName, chapterNumber, verseNumber) {
    
    showContent();
    
    // Update global state with the selected verse number
    currentVerseNumber = verseNumber;
    
    if (!currentBookData || !currentBookData.chapters) {
        console.error("Error: currentBookData or chapters array is missing.");
        alert("Cannot display verse: Book data is missing. Please select the book again.");
        showBooks();
        return;
    }

    // FIX: Ensure the chapter number being searched is consistently treated as an integer (number).
    // This handles cases where chapterNumber might be a string (e.g., "1") while the JSON uses numbers (e.g., 1).
    const chapterNumInt = parseInt(chapterNumber, 10);
    
    // Find the specific chapter object for the breadcrumb construction
    const currentChapter = currentBookData.chapters.find(c => c.chapter === chapterNumInt);
    
    // CRITICAL CHECK: Ensure the chapter is found before accessing its properties
    if (!currentChapter) {
        console.error(`Error: Chapter ${chapterNumber} not found in current book data.`);
        alert(`Chapter ${chapterNumber} not found.`);
        return;
    }
    
    const versesJsonString = JSON.stringify(currentChapter.verses).replace(/"/g, '&quot;');
    
    // 2. BUILD THE FULL CONTEXTUAL BREADCRUMB (in fixed header)
    contentHeader.innerHTML = `
        <button id="navBookTop" class="context-nav-btn" onclick="showBooks()">
            ${bookName}
        </button>
        <button id="navChapterTop" class="context-nav-btn" onclick="displayChapters('${bookName}')">
            Chapter ${chapterNumber}
        </button>
        <button id="navVerseTop" class="context-nav-btn" onclick="displayVerses(${chapterNumber}, JSON.parse('${versesJsonString}'))">
            Verse ${verseNumber}
        </button>
    `;
    
    // 3. Render all chapters and verses of the book
    // ... (rendering logic remains the same)
    contentDisplay.innerHTML = ''; 
    const bookHTML = currentBookData.chapters.map(chapter => {
        let chapterHtml = `<h3 id="Ch${bookName}${chapter.chapter}" class="chapter-heading">Chapter ${chapter.chapter}</h3>`;
        
        chapter.verses.forEach(verse => {
            const verseId = `V${bookName}${chapter.chapter}:${verse.verse}`;
            let verseClass = 'verse-text';

            if (chapter.chapter === chapterNumber && verse.verse === verseNumber) {
                verseClass += ' highlighted-verse';
            }
            
            chapterHtml += `<p id="${verseId}" class="${verseClass}"><strong>${verse.verse}.</strong> ${verse.text}</p>`;
        });
        return chapterHtml;
    }).join('');
    
    contentDisplay.innerHTML = bookHTML;

    // 4. SCROLL to the selected verse
    const targetElementId = `V${bookName}${chapterNumber}:${verseNumber}`;
    const targetElement = document.getElementById(targetElementId);
    
    if (targetElement) {
        // Scroll the highlighted element to the center of the screen
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
    }
}

        // Initialize the app by loading the book buttons
        loadBookList();
    </script>

</body>
</html>
